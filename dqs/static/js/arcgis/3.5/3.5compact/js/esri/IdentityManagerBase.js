/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/IdentityManagerBase",["dojo/_base/declare","dojo/_base/config","dojo/_base/lang","dojo/_base/array","dojo/_base/Deferred","dojo/_base/json","dojo/_base/url","dojo/has","dojo/cookie","esri/kernel","esri/config","esri/lang","esri/ServerInfo","esri/urlUtils","esri/deferredUtils","esri/request","esri/Evented"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11){var _12={};var _13=function(_14){var _15=new _7(_14.owningSystemUrl).host,_16=new _7(_14.server).host,_17=/.+\.arcgis\.com$/i;return (_17.test(_15)&&_17.test(_16));},_18=function(_19,_1a){return !!(_13(_19)&&_1a&&_4.some(_1a,function(_1b){return _1b.test(_19.server);}));};var _1c;var _1d=_1(_11,{declaredClass:"esri.IdentityManagerBase",constructor:function(){this._portalConfig=_3.getObject("esriGeowConfig");this.serverInfos=[];this.credentials=[];this._soReqs=[];this._xoReqs=[];this._portals=[];},defaultTokenValidity:60,tokenValidity:null,signInPage:null,_busy:null,_gwTokenUrl:"/sharing/generateToken",_agsRest:"/rest/services",_agsPortal:/\/sharing(\/|$)/i,_agsAdmin:/https?:\/\/[^\/]+\/[^\/]+\/admin\/?(\/.*)?$/i,_agolSuffix:".arcgis.com",_gwDomains:[{regex:/https?:\/\/www\.arcgis\.com/i,tokenServiceUrl:"https://www.arcgis.com/sharing/generateToken"},{regex:/https?:\/\/dev\.arcgis\.com/i,tokenServiceUrl:"https://dev.arcgis.com/sharing/generateToken"},{regex:/https?:\/\/.*dev[^.]*\.arcgis\.com/i,tokenServiceUrl:"https://devext.arcgis.com/sharing/generateToken"},{regex:/https?:\/\/.*qa[^.]*\.arcgis\.com/i,tokenServiceUrl:"https://qaext.arcgis.com/sharing/generateToken"},{regex:/https?:\/\/.*.arcgis\.com/i,tokenServiceUrl:"https://www.arcgis.com/sharing/generateToken"}],_legacyFed:[/https?:\/\/analysis[^.]*\.arcgis\.com/i],_regexSDirUrl:/http.+\/rest\/services\/?/ig,_regexServerType:/(\/(MapServer|GeocodeServer|GPServer|GeometryServer|ImageServer|NAServer|FeatureServer|GeoDataServer|GlobeServer|MobileServer)).*/ig,_gwUser:/http.+\/users\/([^\/]+)\/?.*/i,_gwItem:/http.+\/items\/([^\/]+)\/?.*/i,_gwGroup:/http.+\/groups\/([^\/]+)\/?.*/i,_errorCodes:[499,498,403,401],_publicUrls:[/\/arcgis\/tokens/i,/\/sharing\/generatetoken/i,/\/rest\/info/i],registerServers:function(_1e){var _1f=this.serverInfos;if(_1f){_1e=_4.filter(_1e,function(_20){return !this.findServerInfo(_20.server);},this);this.serverInfos=_1f.concat(_1e);}else{this.serverInfos=_1e;}_4.forEach(_1e,function(_21){if(_21.owningSystemUrl){this._portals.push(_21.owningSystemUrl);}if(_21.hasPortal){var _22=_b.defaults.io.corsEnabledServers,_23=this._getOrigin(_21.tokenServiceUrl);if(!_e.canUseXhr(_21.server)){_22.push(_21.server.replace(/^https?:\/\//i,""));}if(!_e.canUseXhr(_23)){_22.push(_23.replace(/^https?:\/\//i,""));}}},this);},registerToken:function(_24){var _25=this._sanitizeUrl(_24.server),_26=this.findServerInfo(_25),_27;if(!_26){_26=new _d();_26.server=this._getOrigin(_25);_26.tokenServiceUrl=this._getTokenSvcUrl(_25);_26.hasPortal=true;this.registerServers([_26]);}_27=this.findCredential(_25,_24.userId);if(_27){_3.mixin(_27,_24);}else{_27=new _1c({userId:_24.userId,server:_26.server,token:_24.token,expires:_24.expires,ssl:_24.ssl,scope:this._isServerRsrc(_25)?"server":"portal"});_27.resources=[_25];this.credentials.push(_27);}_27.onTokenChange(false);},toJson:function(){return _c.fixJson({"serverInfos":_4.map(this.serverInfos,function(_28){return _28.toJson();}),"credentials":_4.map(this.credentials,function(crd){return crd.toJson();})});},initialize:function(_29){if(!_29){return;}if(_3.isString(_29)){_29=_6.fromJson(_29);}var _2a=_29.serverInfos,_2b=_29.credentials;if(_2a){var _2c=[];_4.forEach(_2a,function(_2d){if(_2d.server&&_2d.tokenServiceUrl){_2c.push(_2d.declaredClass?_2d:new _d(_2d));}});if(_2c.length){this.registerServers(_2c);}}if(_2b){_4.forEach(_2b,function(crd){if(crd.userId&&crd.server&&crd.token&&crd.expires&&(crd.expires>(new Date()).getTime())){crd=crd.declaredClass?crd:new _1c(crd);crd.onTokenChange();this.credentials.push(crd);}},this);}},findServerInfo:function(_2e){var _2f;_2e=this._sanitizeUrl(_2e);_4.some(this.serverInfos,function(_30){if(_e.hasSameOrigin(_30.server,_2e,true)){_2f=_30;}return !!_2f;});return _2f;},findCredential:function(_31,_32){var _33,_34;_31=this._sanitizeUrl(_31);_34=this._isServerRsrc(_31)?"server":"portal";if(_32){_4.some(this.credentials,function(crd){if(_e.hasSameOrigin(_31,crd.server,true)&&_32===crd.userId&&crd.scope===_34){_33=crd;}return !!_33;},this);}else{_4.some(this.credentials,function(crd){if(_e.hasSameOrigin(_31,crd.server,true)&&this._getIdenticalSvcIdx(_31,crd)!==-1&&crd.scope===_34){_33=crd;}return !!_33;},this);}return _33;},getCredential:function(_35,_36){var _37,_38;if(_c.isDefined(_36)){if(_3.isObject(_36)){_37=!!_36.token;_38=_36.error;}else{_37=_36;}}_35=this._sanitizeUrl(_35);var dfd=new _5(_f._dfdCanceller),err,_39=this._isAdminResource(_35),_3a=(_37&&this._doPortalSignIn(_35))?_9("esri_auth"):null;if(_3a){_3a=_6.fromJson(_3a);err=new Error("You are currently signed in as: '"+_3a.email+"'. You do not have access to this resource: "+_35);err.code="IdentityManagerBase."+1;err.messageCode=_38?_38.messageCode:null;err.subcode=_38?_38.subcode:null;err.log=_2.isDebug;dfd.errback(err);return dfd;}var _3b=this._findCredential(_35,_36);if(_3b){dfd.callback(_3b);return dfd;}var _3c=this.findServerInfo(_35);if(!_3c){var _3d=this._getTokenSvcUrl(_35);if(!_3d){err=new Error("Unknown resource - could not find token service endpoint.");err.code="IdentityManagerBase."+2;err.log=_2.isDebug;dfd.errback(err);return dfd;}_3c=new _d();_3c.server=this._getOrigin(_35);if(_3.isString(_3d)){_3c.tokenServiceUrl=_3d;_3c.hasPortal=true;}else{_3c._restInfoDfd=_3d;_3c.hasServer=true;}this.registerServers([_3c]);}else{if(this._isServerRsrc(_35)&&!_3c.hasServer){_3c._restInfoDfd=this._getTokenSvcUrl(_35,true);_3c.hasServer=true;}}return this._enqueue(_35,_3c,_36,dfd,_39);},getResourceName:function(_3e){if(this._isRESTService(_3e)){return _3e.replace(this._regexSDirUrl,"").replace(this._regexServerType,"")||"";}else{return (this._gwUser.test(_3e)&&_3e.replace(this._gwUser,"$1"))||(this._gwItem.test(_3e)&&_3e.replace(this._gwItem,"$1"))||(this._gwGroup.test(_3e)&&_3e.replace(this._gwGroup,"$1"))||"";}},generateToken:function(_3f,_40,_41){var _42,_43,_44,_45=_3f.shortLivedTokenValidity,_46=_a.id.tokenValidity||_45||_a.id.defaultTokenValidity;if(_46>_45){_46=_45;}if(_41){_42=_41.isAdmin;_43=_41.serverUrl;_44=_41.token;}var _47=_10({url:_42?_3f.adminTokenServiceUrl:_3f.tokenServiceUrl,content:{request:"getToken",username:_40&&_40.username,password:_40&&_40.password,serverUrl:_43,token:_44,expiration:_46,referer:(_42||_3f.tokenServiceUrl.toLowerCase().indexOf("/sharing/generatetoken")!==-1)?window.location.host:null,client:_42?"referer":null,f:"json"},handleAs:"json"},{usePost:true,disableIdentityLookup:true,useProxy:this._useProxy(_3f,_41)});_47.addCallback(function(_48){if(!_48||!_48.token){var err=new Error("Unable to generate token");err.code="IdentityManagerBase."+3;err.log=_2.isDebug;return err;}var _49=_3f.server;if(!_12[_49]){_12[_49]={};}if(_40){_12[_49][_40.username]=_40.password;}_48.validity=_46;return _48;});_47.addErrback(function(_4a){});return _47;},isBusy:function(){return !!this._busy;},setRedirectionHandler:function(_4b){this._redirectFunc=_4b;},setProtocolErrorHandler:function(_4c){this._protocolFunc=_4c;},signIn:function(){},_findCredential:function(_4d,_4e){var idx=-1,_4f,_50,_51,_52,_53=_4e&&_4e.token,_54=_4e&&_4e.resource,_55=this._isServerRsrc(_4d)?"server":"portal",_56=_4.filter(this.credentials,function(crd){return (_e.hasSameOrigin(crd.server,_4d,true)&&crd.scope===_55);});_4d=_54||_4d;if(_56.length){if(_56.length===1){_4f=_56[0];_52=this.findServerInfo(_4f.server);_50=_52&&_52.owningSystemUrl;_51=_50&&this.findCredential(_50,_4f.userId);idx=this._getIdenticalSvcIdx(_4d,_4f);if(_53){if(idx!==-1){_4f.resources.splice(idx,1);this._removeResource(_4d,_51);}}else{if(idx===-1){_4f.resources.push(_4d);}this._addResource(_4d,_51);return _4f;}}else{var _57,i;_4.some(_56,function(crd){i=this._getIdenticalSvcIdx(_4d,crd);if(i!==-1){_57=crd;_52=this.findServerInfo(_57.server);_50=_52&&_52.owningSystemUrl;_51=_50&&this.findCredential(_50,_57.userId);idx=i;return true;}return false;},this);if(_53){if(_57){_57.resources.splice(idx,1);this._removeResource(_4d,_51);}}else{if(_57){this._addResource(_4d,_51);return _57;}}}}},_addResource:function(_58,_59){if(_59){if(this._getIdenticalSvcIdx(_58,_59)===-1){_59.resources.push(_58);}}},_removeResource:function(_5a,_5b){var idx=-1;if(_5b){idx=this._getIdenticalSvcIdx(_5a,_5b);if(idx>-1){_5b.resources.splice(idx,1);}}},_useProxy:function(_5c,_5d){return (_5d&&_5d.isAdmin)||(!this._isPortalDomain(_5c.tokenServiceUrl)&&_5c.currentVersion==10.1&&!_e.hasSameOrigin(_5c.tokenServiceUrl,window.location.href));},_getOrigin:function(_5e){var uri=new _7(_5e);return uri.scheme+"://"+uri.host+(_c.isDefined(uri.port)?(":"+uri.port):"");},_sanitizeUrl:function(url){url=_3.trim(url);var _5f=(_b.defaults.io.proxyUrl||"").toLowerCase(),_60=_5f?url.toLowerCase().indexOf(_5f+"?"):-1;if(_60!==-1){url=url.substring(_60+_5f.length+1);}return _e.urlToObject(url).path;},_isRESTService:function(_61){return (_61.indexOf(this._agsRest)>-1);},_isAdminResource:function(_62){return this._agsAdmin.test(_62);},_isServerRsrc:function(_63){return (this._isRESTService(_63)||this._isAdminResource(_63));},_isIdenticalService:function(_64,_65){var _66;if(this._isRESTService(_64)&&this._isRESTService(_65)){var _67=this._getSuffix(_64).toLowerCase(),_68=this._getSuffix(_65).toLowerCase();_66=(_67===_68);if(!_66){var _69=/(.*)\/(MapServer|FeatureServer).*/ig;_66=(_67.replace(_69,"$1")===_68.replace(_69,"$1"));}}else{if(this._isAdminResource(_64)&&this._isAdminResource(_65)){_66=true;}else{if(!this._isServerRsrc(_64)&&!this._isServerRsrc(_65)&&this._isPortalDomain(_64)){_66=true;}}}return _66;},_isPortalDomain:function(_6a){_6a=_6a.toLowerCase();var _6b=(new _7(_6a)).authority,_6c=this._portalConfig,_6d=(_6b.indexOf(this._agolSuffix)!==-1);if(!_6d&&_6c){_6d=_e.hasSameOrigin(_6c.restBaseUrl,_6a,true);}if(!_6d){if(!this._arcgisUrl){var _6e=_3.getObject("esri.arcgis.utils.arcgisUrl");if(_6e){this._arcgisUrl=(new _7(_6e)).authority;}}if(this._arcgisUrl){_6d=(this._arcgisUrl.toLowerCase()===_6b);}}if(!_6d){_6d=_4.some(this._portals,function(_6f){return _e.hasSameOrigin(_6f,_6a,true);});}_6d=_6d||this._agsPortal.test(_6a);return _6d;},_isIdProvider:function(_70,_71){var i=-1,j=-1;_4.forEach(this._gwDomains,function(_72,idx){if(i===-1&&_72.regex.test(_70)){i=idx;}if(j===-1&&_72.regex.test(_71)){j=idx;}});var _73=false;if(i>-1&&j>-1){if(i===0||i===4){if(j===0||j===4){_73=true;}}else{if(i===1){if(j===1||j===2){_73=true;}}else{if(i===2){if(j===2){_73=true;}}else{if(i===3){if(j===3){_73=true;}}}}}}if(!_73){var _74=this.findServerInfo(_71),_75=_74&&_74.owningSystemUrl;if(_75&&_13(_74)&&this._isPortalDomain(_75)&&this._isIdProvider(_70,_75)){_73=true;}}return _73;},_isPublic:function(_76){_76=this._sanitizeUrl(_76);return _4.some(this._publicUrls,function(_77){return _77.test(_76);});},_getIdenticalSvcIdx:function(_78,_79){var idx=-1;_4.some(_79.resources,function(_7a,i){if(this._isIdenticalService(_78,_7a)){idx=i;return true;}return false;},this);return idx;},_getSuffix:function(_7b){return _7b.replace(this._regexSDirUrl,"").replace(this._regexServerType,"$1");},_getTokenSvcUrl:function(_7c,_7d){var _7e,dfd,idx;if(this._isRESTService(_7c)){idx=_7c.toLowerCase().indexOf(this._agsRest);_7e=_7c.substring(0,idx)+"/admin/generateToken";_7c=_7c.substring(0,idx+"/rest/".length)+"info";if(this._isPortalDomain(_7c)&&!_7d){_7c=_7c.replace(/http:/i,"https:");}dfd=_10({url:_7c,content:{f:"json"},handleAs:"json",callbackParamName:"callback"});dfd.adminUrl_=_7e;return dfd;}else{if(this._isPortalDomain(_7c)){var url="";_4.some(this._gwDomains,function(_7f){if(_7f.regex.test(_7c)){url=_7f.tokenServiceUrl;}return !!url;});if(!url){_4.some(this._portals,function(_80){if(_e.hasSameOrigin(_80,_7c,true)){url=_80+this._gwTokenUrl;}return !!url;},this);}if(!url){idx=_7c.toLowerCase().indexOf("/sharing");if(idx!==-1){url=_7c.substring(0,idx)+this._gwTokenUrl;}}if(!url){url=this._getOrigin(_7c)+this._gwTokenUrl;}if(url){var _81=new _7(_7c).port;if(/^http:\/\//i.test(_7c)&&_81==="7080"){url=url.replace(/:7080/i,":7443");}url=url.replace(/http:/i,"https:");}return url;}else{if(_7c.toLowerCase().indexOf("premium.arcgisonline.com")!==-1){return "https://premium.arcgisonline.com/server/tokens";}else{if(this._isAdminResource(_7c)){idx=_7c.toLowerCase().indexOf("/admin/");_7e=_7c.substring(0,idx+"/admin/".length)+"generateToken";_7c=_7c.substring(0,idx)+"/rest/info";dfd=_10({url:_7c,content:{f:"json"},handleAs:"json",callbackParamName:"callback"});dfd.adminUrl_=_7e;return dfd;}}}}},_hasPortalSession:function(){return _9.isSupported()?!!_9("esri_auth"):false;},_doPortalSignIn:function(_82){if(_9.isSupported()){var _83=_9("esri_auth"),_84=this._portalConfig,_85=window.location.href,_86=this.findServerInfo(_82);if((_84||this._isPortalDomain(_85)||_83)&&(this._isPortalDomain(_82)||(_86&&_86.owningSystemUrl&&this._isPortalDomain(_86.owningSystemUrl)))&&(this._isIdProvider(_85,_82)||(_84&&(_e.hasSameOrigin(_84.restBaseUrl,_82,true)||this._isIdProvider(_84.restBaseUrl,_82)))||_e.hasSameOrigin(_85,_82,true))){return true;}}return false;},_checkProtocol:function(_87,_88,_89,_8a){var _8b=true,_8c=_8a?_88.adminTokenServiceUrl:_88.tokenServiceUrl;if(_3.trim(_8c).toLowerCase().indexOf("https:")===0&&window.location.href.toLowerCase().indexOf("https:")!==0&&!_e.canUseXhr(_8c)&&!_e.canUseXhr(_e.getProxyUrl(true).path)){_8b=this._protocolFunc?!!this._protocolFunc({resourceUrl:_87,serverInfo:_88}):false;if(!_8b){var err=new Error("Aborted the Sign-In process to avoid sending password over insecure connection.");err.code="IdentityManagerBase."+4;err.log=_2.isDebug;console.log(err.message);_89(err);}}return _8b;},_enqueue:function(_8d,_8e,_8f,dfd,_90,_91){if(!dfd){dfd=new _5(_f._dfdCanceller);}dfd.resUrl_=_8d;dfd.sinfo_=_8e;dfd.options_=_8f;dfd.admin_=_90;dfd.refresh_=_91;if(this._busy){if(_e.hasSameOrigin(_8d,this._busy.resUrl_,true)){this._soReqs.push(dfd);}else{this._xoReqs.push(dfd);}}else{this._doSignIn(dfd);}return dfd;},_doSignIn:function(dfd){this._busy=dfd;var _92=this;var _93=function(_94){var _95=dfd.options_&&dfd.options_.resource,_96=dfd.resUrl_,_97=dfd.refresh_;if(_4.indexOf(_92.credentials,_94)===-1){if(_97&&_4.indexOf(_92.credentials,_97)!==-1){_97.userId=_94.userId;_97.token=_94.token;_97.expires=_94.expires;_97.validity=_94.validity;_97.ssl=_94.ssl;_97.creationTime=_94.creationTime;_94=_97;}else{_92.credentials.push(_94);}}if(!_94.resources){_94.resources=[];}_94.resources.push(_95||_96);_94.scope=_92._isServerRsrc(_96)?"server":"portal";_94.onTokenChange();var _98=_92._soReqs,_99={};_92._soReqs=[];_4.forEach(_98,function(_9a){if(!this._isIdenticalService(_96,_9a.resUrl_)){var _9b=this._getSuffix(_9a.resUrl_);if(!_99[_9b]){_99[_9b]=true;_94.resources.push(_9a.resUrl_);}}},_92);dfd.callback(_94);_4.forEach(_98,function(_9c){_9c.callback(_94);});_92._busy=dfd.resUrl_=dfd.sinfo_=dfd.refresh_=null;if(_92._soReqs.length){_92._doSignIn(_92._soReqs.shift());}if(_92._xoReqs.length){_92._doSignIn(_92._xoReqs.shift());}},_9d=function(_9e){dfd.errback(_9e);_92._busy=dfd.resUrl_=dfd.sinfo_=dfd.refresh_=null;if(_92._soReqs.length){_92._doSignIn(_92._soReqs.shift());}if(_92._xoReqs.length){_92._doSignIn(_92._xoReqs.shift());}},_9f=function(){var _a0=dfd.sinfo_;if(_92._doPortalSignIn(dfd.resUrl_)){var _a1=_9("esri_auth"),_a2=_92._portalConfig;if(_a1){_a1=_6.fromJson(_a1);_93(new _1c({userId:_a1.email,server:_a0.server,token:_a1.token,expires:null}));return;}else{var _a3="",_a4=window.location.href;if(_92.signInPage){_a3=_92.signInPage;}else{if(_a2){_a3=_a2.baseUrl+_a2.signin;}else{if(_92._isIdProvider(_a4,dfd.resUrl_)){_a3=_92._getOrigin(_a4)+"/home/signin.html";}else{_a3=_a0.server+"/home/signin.html";}}}_a3=_a3.replace(/http:/i,"https:");if(_a2&&_a2.useSSL===false){_a3=_a3.replace(/https:/i,"http:");}if(_a4.toLowerCase().replace("https","http").indexOf(_a3.toLowerCase().replace("https","http"))===0){var err=new Error("Cannot redirect to Sign-In page from within Sign-In page. URL of the resource that triggered this workflow: "+dfd.resUrl_);err.code="IdentityManagerBase."+5;err.log=_2.isDebug;_9d(err);}else{if(_92._redirectFunc){_92._redirectFunc({signInPage:_a3,returnUrlParamName:"returnUrl",returnUrl:_a4,resourceUrl:dfd.resUrl_,serverInfo:_a0});}else{window.location=_a3+"?returnUrl="+window.escape(_a4);}}return;}}else{if(_92._checkProtocol(dfd.resUrl_,_a0,_9d,dfd.admin_)){var _a5=dfd.options_;if(dfd.admin_){_a5=_a5||{};_a5.isAdmin=true;}dfd._pendingDfd=_92.signIn(dfd.resUrl_,_a0,_a5).addCallbacks(_93,_9d);}}},_a6=function(){var _a7=dfd.sinfo_,_a8=_a7.owningSystemUrl,_a9=dfd.options_,_aa,_ab,_ac;if(_a9){_aa=_a9.token;_ab=_a9.error;}_ac=_92._findCredential(_a8,{token:_aa,resource:dfd.resUrl_});if(!_ac&&_13(_a7)){_4.some(_92.credentials,function(_ad){if(this._isIdProvider(_a8,_ad.server)){_ac=_ad;}return !!_ac;},_92);}if(_ac){var _ae=_92.findCredential(dfd.resUrl_,_ac.userId);if(_ae){_93(_ae);}else{if(_18(_a7,_92._legacyFed)){var _af=_ac.toJson();_af.server=_a7.server;_af.resources=null;_93(new _1c(_af));}else{var _b0=(dfd._pendingDfd=_92.generateToken(_92.findServerInfo(_ac.server),null,{serverUrl:dfd.resUrl_,token:_ac.token}));_b0.addCallbacks(function(_b1){_93(new _1c({userId:_ac.userId,server:_a7.server,token:_b1.token,expires:_c.isDefined(_b1.expires)?Number(_b1.expires):null,ssl:!!_b1.ssl,isAdmin:dfd.admin_,validity:_b1.validity}));},_9d);}}}else{_92._busy=null;if(_aa){dfd.options_.token=null;}var _b2=(dfd._pendingDfd=_92.getCredential(_a8.replace(/\/?$/,"/sharing"),{resource:dfd.resUrl_,token:_aa,error:_ab}));_b2.addCallbacks(function(_b3){_92._enqueue(dfd.resUrl_,dfd.sinfo_,dfd.options_,dfd,dfd.admin_);},function(_b4){_9d(_b4);});}};var _b5=dfd.sinfo_.tokenServiceUrl,_b6=dfd.sinfo_.owningSystemUrl,_b7=this._isServerRsrc(dfd.resUrl_),_b8=dfd.sinfo_._restInfoDfd;if(!_b8){if(_b7&&_b6){_a6();}else{_9f();}}else{_b8.addCallbacks(function(_b9){var _ba=dfd.sinfo_;_ba.adminTokenServiceUrl=_ba._restInfoDfd.adminUrl_;_ba._restInfoDfd=null;_ba.tokenServiceUrl=_3.getObject("authInfo.tokenServicesUrl",false,_b9)||_3.getObject("authInfo.tokenServiceUrl",false,_b9)||_3.getObject("tokenServiceUrl",false,_b9);_ba.shortLivedTokenValidity=_3.getObject("authInfo.shortLivedTokenValidity",false,_b9);_ba.currentVersion=_b9.currentVersion;_ba.owningTenant=_b9.owningTenant;var _bb=(_ba.owningSystemUrl=_b9.owningSystemUrl);if(_bb){_92._portals.push(_bb);if(!_ba.hasPortal&&_e.hasSameOrigin(_bb,dfd.resUrl_,true)){_ba.hasPortal=true;}}if(_b7&&_bb){_a6();}else{_9f();}},function(){dfd.sinfo_._restInfoDfd=null;var err=new Error("Unknown resource - could not find token service endpoint.");err.code="IdentityManagerBase."+2;err.log=_2.isDebug;_9d(err);});}}});_1c=_1(null,{declaredClass:"esri.Credential",tokenRefreshBuffer:2,constructor:function(_bc){_3.mixin(this,_bc);this.resources=this.resources||[];if(!_c.isDefined(this.creationTime)){this.creationTime=(new Date()).getTime();}},refreshToken:function(){var _bd=this,_be=this.resources&&this.resources[0],_bf=_a.id.findServerInfo(this.server),_c0=_bf&&_bf.owningSystemUrl,_c1=!!_c0&&this.scope==="server",_c2=_c1&&_18(_bf,_a.id._legacyFed),_c3=_c1&&_a.id.findServerInfo(_c0),_c4,_c5=_12[this.server],_c6=_c5&&_c5[this.userId],_c7;if(_c1&&!_c3){_4.some(_a.id.serverInfos,function(_c8){if(_a.id._isIdProvider(_c0,_c8.server)){_c3=_c8;}return !!_c3;});}_c4=_c3&&_a.id.findCredential(_c3.server,this.userId);if(_c1&&!_c4){return;}if(_c2){_c4.refreshToken();return;}else{if(_c1){_c7={serverUrl:_be,token:_c4&&_c4.token};}else{if(!_c6){var dfd;if(_be){_be=_a.id._sanitizeUrl(_be);this._enqueued=1;dfd=_a.id._enqueue(_be,_bf,null,null,this.isAdmin,this);dfd.addBoth(function(){_bd._enqueued=0;});}return dfd;}else{if(this.isAdmin){_c7={isAdmin:true};}}}}return _a.id.generateToken(_c1?_c3:_bf,_c1?null:{username:this.userId,password:_c6},_c7).addCallback(function(_c9){_bd.token=_c9.token;_bd.expires=_c.isDefined(_c9.expires)?Number(_c9.expires):null;_bd.creationTime=(new Date()).getTime();_bd.validity=_c9.validity;_bd.onTokenChange();if(_bd.scope==="portal"){_4.forEach(_a.id.credentials,function(_ca){var _cb=_a.id.findServerInfo(_ca.server),_c0=_cb&&_cb.owningSystemUrl;if(_ca!==_bd&&_ca.userId===_bd.userId&&_c0&&_ca.scope==="server"&&(_e.hasSameOrigin(_bd.server,_c0,true)||_a.id._isIdProvider(_c0,_bd.server))){if(_18(_cb,_a.id._legacyFed)){_ca.token=_bd.token;_ca.expires=_bd.expires;_ca.creationTime=_bd.creationTime;_ca.validity=_bd.validity;_ca.onTokenChange();}else{_ca.refreshToken();}}});}}).addErrback(function(){});},onTokenChange:function(_cc){clearTimeout(this._refreshTimer);var _cd=this.server&&_a.id.findServerInfo(this.server),_ce=_cd&&_cd.owningSystemUrl;if((_cc!==false)&&(!_ce||this.scope==="portal")&&(_c.isDefined(this.expires)||_c.isDefined(this.validity))){this._startRefreshTimer();}},onDestroy:function(){},destroy:function(){this.userId=this.server=this.token=this.expires=this.validity=this.resources=this.creationTime=null;var _cf=_4.indexOf(_a.id.credentials,this);if(_cf>-1){_a.id.credentials.splice(_cf,1);}this.onTokenChange();this.onDestroy();},toJson:function(){return this._toJson();},_toJson:function(){var _d0=_c.fixJson({userId:this.userId,server:this.server,token:this.token,expires:this.expires,validity:this.validity,ssl:this.ssl,isAdmin:this.isAdmin,creationTime:this.creationTime,scope:this.scope});var _d1=this.resources;if(_d1&&_d1.length>0){_d0.resources=_d1;}return _d0;},_startRefreshTimer:function(){clearTimeout(this._refreshTimer);var _d2=this.tokenRefreshBuffer*60000,_d3=this.validity?(this.creationTime+(this.validity*60000)):this.expires,_d4=(_d3-(new Date()).getTime());if(_d4<0){_d4=0;}this._refreshTimer=setTimeout(_3.hitch(this,this.refreshToken),(_d4>_d2)?(_d4-_d2):_d4);}});_1d.Credential=_1c;if(_8("extend-esri")){_a.IdentityManagerBase=_1d;_a.Credential=_1c;}return _1d;});