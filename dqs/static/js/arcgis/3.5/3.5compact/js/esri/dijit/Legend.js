/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/dijit/Legend",["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/json","dojo/has","dojo/sniff","dojo/DeferredList","dojo/json","dojo/dom","dojo/dom-construct","dojo/dom-style","dijit/_Widget","dojox/gfx","dojox/html/entities","esri/kernel","esri/config","esri/request","esri/geometry/scaleUtils","esri/renderers/SimpleRenderer","esri/renderers/UniqueValueRenderer","esri/renderers/ClassBreaksRenderer","esri/symbols/jsonUtils","dojo/i18n!esri/nls/jsapi"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18){var _19=_1([_d],{declaredClass:"esri.dijit.Legend",widgetsInTemplate:false,layers:null,alignRight:false,_ieTimer:100,constructor:function(_1a,_1b){_2.mixin(this,_18.widgets.legend);_1a=_1a||{};if(!_1a.map){console.error("esri.dijit.Legend: unable to find the 'map' property in parameters");return;}if(!_1b){console.error("esri.dijit.Legend: must specify a container for the legend");return;}this.map=_1a.map;this.layerInfos=_1a.layerInfos;this._respectCurrentMapScale=(_1a.respectCurrentMapScale===false)?false:true;this.arrangement=(_1a.arrangement===_19.ALIGN_RIGHT)?_19.ALIGN_RIGHT:_19.ALIGN_LEFT;if(this.arrangement===_19.ALIGN_RIGHT){this.alignRight=true;}this.autoUpdate=(_1a.autoUpdate===false)?false:true;this._surfaceItems=[];},startup:function(){this.inherited(arguments);this._initialize();if(_6("ie")){this._repaintItems=_2.hitch(this,this._repaintItems);setTimeout(this._repaintItems,this._ieTimer);}},destroy:function(){this._deactivate();this.inherited(arguments);},refresh:function(_1c){var i;if(!this.domNode){return;}if(_1c){this.layerInfos=_1c;this.layers=[];_3.forEach(this.layerInfos,function(_1d){if(this._isSupportedLayerType(_1d.layer)){if(_1d.title){_1d.layer._titleForLegend=_1d.title;}if(_1d.defaultSymbol===false){_1d.layer._hideDefaultSymbolInLegend=true;}if(_1d.hideLayers){_1d.layer._hideLayersInLegend=_1d.hideLayers;this._addSubLayersToHide(_1d);}else{_1d.layer._hideLayersInLegend=[];}this.layers.push(_1d.layer);}},this);}else{if(this.useAllMapLayers){this.layerInfos=null;this.layers=null;}}for(i=this.domNode.children.length-1;i>=0;i--){_b.destroy(this.domNode.children[i]);}this.startup();},_legendUrl:"http://utility.arcgis.com/sharing/tools/legend",_initialize:function(){if(this.layerInfos){this.layers=[];_3.forEach(this.layerInfos,function(_1e){if(this._isSupportedLayerType(_1e.layer)){if(_1e.title){_1e.layer._titleForLegend=_1e.title;}if(_1e.defaultSymbol===false){_1e.layer._hideDefaultSymbol=true;}if(_1e.hideLayers){_1e.layer._hideLayersInLegend=_1e.hideLayers;this._addSubLayersToHide(_1e);}else{_1e.layer._hideLayersInLegend=[];}this.layers.push(_1e.layer);}},this);}this.useAllMapLayers=false;if(!this.layers){this.useAllMapLayers=true;this.layers=[];var _1f=[];var _20=[];_3.forEach(this.map.layerIds,function(_21){var _22=this.map.getLayer(_21),_23;if(this._isSupportedLayerType(_22)){if(_22.arcgisProps&&_22.arcgisProps.title){_22._titleForLegend=_22.arcgisProps.title;}this.layers.push(_22);}if(_22.declaredClass=="esri.layers.KMLLayer"){_23=_22.getLayers();_3.forEach(_23,function(_24){_1f.push(_24.id);},this);}if(_22.declaredClass=="esri.layers.GeoRSSLayer"){_23=_22.getFeatureLayers();_3.forEach(_23,function(_25){_20.push(_25.id);},this);}},this);_3.forEach(this.map.graphicsLayerIds,function(_26){var _27=this.map.getLayer(_26);if(_3.indexOf(_1f,_26)==-1&&_3.indexOf(_20,_26)==-1){if(this._isSupportedLayerType(_27)&&_27._params&&_27._params.drawMode){if(_27.arcgisProps&&_27.arcgisProps.title){_27._titleForLegend=_27.arcgisProps.title;}this.layers.push(_27);}}},this);}this._createLegend();},_activate:function(){this._deactivate();if(!this.autoUpdate){return;}if(this._respectCurrentMapScale){this._ozeConnect=_4.connect(this.map,"onZoomEnd",this,"_refreshLayers");}if(this.useAllMapLayers){this._olaConnect=_4.connect(this.map,"onLayerAdd",this,"_updateAllMapLayers");this._olrConnect=_4.connect(this.map,"onLayerRemove",this,"_updateAllMapLayers");this._olroConnect=_4.connect(this.map,"onLayersReordered",this,"_updateAllMapLayers");}_3.forEach(this.layers,function(_28){_28.ovcConnect=_4.connect(_28,"onVisibilityChange",this,"_refreshLayers");_28.oscConnect=_4.connect(_28,"onScaleRangeChange",this,"_refreshLayers");if(_28.declaredClass==="esri.layers.ArcGISDynamicMapServiceLayer"&&_28.supportsDynamicLayers){_28.odcConnect=_4.connect(_28,"_onDynamicLayersChange",_2.hitch(this,"_updateDynamicLayers",_28));}if(_28.declaredClass==="esri.layers.ArcGISImageServiceLayer"){_28.oirConnect=_4.connect(_28,"onRenderingChange",_2.partial(this._updateImageServiceLayers,this,_28));}},this);},_deactivate:function(){if(this._ozeConnect){_4.disconnect(this._ozeConnect);}if(this._olaConnect){_4.disconnect(this._olaConnect);}if(this._olroConnect){_4.disconnect(this._olroConnect);}if(this._olrConnect){_4.disconnect(this._olrConnect);}_3.forEach(this.layers,function(_29){if(_29.ovcConnect){_4.disconnect(_29.ovcConnect);}if(_29.oscConnect){_4.disconnect(_29.oscConnect);}if(_29.odcConnect){_4.disconnect(_29.odcConnect);}if(_29.oirConnect){_4.disconnect(_29.oirConnect);}},this);},_updateDynamicLayers:function(_2a){delete _2a.legendResponse;this._refreshLayers();},_updateImageServiceLayers:function(_2b,_2c){delete _2c.legendResponse;_2b._refreshLayers();},_refreshLayers:function(){this.refresh();},_updateAllMapLayers:function(){this.layers=[];_3.forEach(this.map.layerIds,function(_2d){var _2e=this.map.getLayer(_2d);if(this._isSupportedLayerType(_2e)){this.layers.push(_2e);}},this);_3.forEach(this.map.graphicsLayerIds,function(_2f){var _30=this.map.getLayer(_2f);if(this._isSupportedLayerType(_30)&&_30._params&&_30._params.drawMode){this.layers.push(_30);}},this);this.refresh();},_createLegend:function(){var _31=false;_c.set(this.domNode,"position","relative");_b.create("div",{id:this.id+"_msg",innerHTML:this.NLS_creatingLegend+"..."},this.domNode);var _32=[];_3.forEach(this.layers,function(_33){if(_33.declaredClass=="esri.layers.KMLLayer"||_33.declaredClass=="esri.layers.GeoRSSLayer"){var _34;if(!_33.loaded){_4.connect(_33,"onLoad",_2.hitch(this,function(){this.refresh(this.layerInfos);}));}else{if(_33.declaredClass=="esri.layers.KMLLayer"){_34=_33.getLayers();}else{if(_33.declaredClass=="esri.layers.GeoRSSLayer"){_34=_33.getFeatureLayers();if(_33._hideLayersInLegend){_34=_3.filter(_34,function(_35){return (_3.indexOf(_33._hideLayersInLegend,_35.id)==-1);});}}}_3.forEach(_34,function(_36){if(_36.declaredClass=="esri.layers.FeatureLayer"&&_33._titleForLegend){_36._titleForLegend=_33._titleForLegend+" - ";if(_36.geometryType=="esriGeometryPoint"){_36._titleForLegend+=this.NLS_points;}else{if(_36.geometryType=="esriGeometryPolyline"){_36._titleForLegend+=this.NLS_lines;}else{if(_36.geometryType=="esriGeometryPolygon"){_36._titleForLegend+=this.NLS_polygons;}}}_32.push(_36);}},this);}}else{if(_33.declaredClass==="esri.layers.WMSLayer"){if(!_33.loaded){_4.connect(_33,"onLoad",_2.hitch(this,function(){this.refresh(this.layerInfos);}));}else{if(_33.visible&&_33.layerInfos.length>0&&_3.some(_33.layerInfos,function(_37){return _37.legendURL;})){var _38=_33._titleForLegend||_33.name||_33.id;_b.create("div",{innerHTML:"<span class='esriLegendServiceLabel'>"+_38+"</span>"},this.domNode);_3.forEach(_33.layerInfos,function(_39){if(_3.indexOf(_33.visibleLayers,_39.name)>-1){_b.create("div",{innerHTML:"<img src='"+_39.legendURL+"'/>"},this.domNode);_31=true;}},this);}}}else{_32.push(_33);}}},this);var _3a=[];_3.forEach(_32,function(_3b){if(!_3b.loaded){var _3c=_4.connect(_3b,"onLoad",this,function(_3d){_4.disconnect(_3c);_3c=null;this.refresh();});}else{if(_3b.visible===true&&(_3b.layerInfos||_3b.renderer)){var d=_b.create("div",{id:this.id+"_"+_3b.id,style:"display: none;","class":"esriLegendService"});_b.create("span",{innerHTML:this._getServiceTitle(_3b),"class":"esriLegendServiceLabel"},_b.create("td",{align:(this.alignRight?"right":"")},_b.create("tr",{},_b.create("tbody",{},_b.create("table",{width:"95%"},d)))));_b.place(d,this.id,"first");if(_6("ie")){_c.set(_a.byId(this.id+"_"+_3b.id),"display","none");}if(_3b.legendResponse||_3b.renderer){this._createLegendForLayer(_3b);}else{_3a.push(this._legendRequest(_3b));}}}},this);if(_3a.length===0&&!_31){_a.byId(this.id+"_msg").innerHTML=this.NLS_noLegend;this._activate();}else{var _3e=new _8(_3a);_3e.addCallback(_2.hitch(this,function(_3f){if(!_31){_a.byId(this.id+"_msg").innerHTML=this.NLS_noLegend;}else{_a.byId(this.id+"_msg").innerHTML="";}this._activate();}));}},_createLegendForLayer:function(_40){if(_40.legendResponse||_40.renderer){var _41=false;if(_40.legendResponse){var _42=_40.dynamicLayerInfos||_40.layerInfos;if(_42){_3.forEach(_42,function(_43,i){if(!_40._hideLayersInLegend||_3.indexOf(_40._hideLayersInLegend,_43.id)==-1){var f=this._buildLegendItems(_40,_43,i);_41=_41||f;}},this);}else{if(_40.declaredClass=="esri.layers.ArcGISImageServiceLayer"){_41=this._buildLegendItems(_40,{id:0,name:null,title:_40.name,subLayerIds:null,parentLayerId:-1},0);}}}else{if(_40.renderer){var id;if(!_40.url){id="fc_"+_40.id;}else{id=_40.url.substring(_40.url.lastIndexOf("/")+1,_40.url.length);}_41=this._buildLegendItems(_40,{id:id,name:null,subLayerIds:null,parentLayerId:-1},0);}}if(_41){_c.set(_a.byId(this.id+"_"+_40.id),"display","block");_c.set(_a.byId(this.id+"_msg"),"display","none");}}},_legendRequest:function(_44){if(!_44.loaded){_4.connect(_44,"onLoad",_2.hitch(this,"_legendRequest"));return;}if(_44.version>=10.01){return this._legendRequestServer(_44);}else{return this._legendRequestTools(_44);}},_legendRequestServer:function(_45){var url=_45.url;var pos=url.indexOf("?");if(pos>-1){url=url.substring(0,pos)+"/legend"+url.substring(pos);}else{url+="/legend";}var _46=_45._getToken();if(_46){url+="?token="+_46;}var _47=_2.hitch(this,"_processLegendResponse");var _48={};_48.f="json";if(_45._params.dynamicLayers){_48.dynamicLayers=_9.stringify(this._createDynamicLayers(_45));if(_48.dynamicLayers==="[{}]"){_48.dynamicLayers="[]";}}if(_45._params.bandIds){_48.bandIds=_45._params.bandIds;}if(_45._params.renderingRule){_48.renderingRule=_45._params.renderingRule;}var _49=_12({url:url,content:_48,callbackParamName:"callback",load:function(_4a,_4b){_47(_45,_4a,_4b);},error:_11.defaults.io.errorHandler});return _49;},_legendRequestTools:function(_4c){var p=_4c.url.toLowerCase().indexOf("/rest/");var _4d=_4c.url.substring(0,p)+_4c.url.substring(p+5,_4c.url.length);var url=this._legendUrl+"?soapUrl="+window.escape(_4d);if(!_6("ie")||_6("ie")>8){url+="&returnbytes=true";}var _4e=_2.hitch(this,"_processLegendResponse");var _4f={};_4f.f="json";var _50=_12({url:url,content:_4f,callbackParamName:"callback",load:function(_51,_52){_4e(_4c,_51,_52);},error:_11.defaults.io.errorHandler});return _50;},_processLegendResponse:function(_53,_54){if(_54&&_54.layers){_53.legendResponse=_54;if(_a.byId(this.id+"_"+_53.id)){_b.empty(_a.byId(this.id+"_"+_53.id));}_b.create("span",{innerHTML:this._getServiceTitle(_53),"class":"esriLegendServiceLabel"},_b.create("td",{align:(this.alignRight?"right":"")},_b.create("tr",{},_b.create("tbody",{},_b.create("table",{width:"95%"},_a.byId(this.id+"_"+_53.id))))));this._createLegendForLayer(_53);}else{console.log("Legend could not get generated for "+_53.url+": "+_5.toJson(_54));}},_buildLegendItems:function(_55,_56,pos){var _57=false;var _58=_a.byId(this.id+"_"+_55.id);var _59=_56.subLayerIds;var _5a=_56.parentLayerId;if(_59){var _5b=_b.create("div",{id:this.id+"_"+_55.id+"_"+_56.id+"_group",style:"display: none;","class":(_5a==-1)?((pos>0)?"esriLegendGroupLayer":""):(this.alignRight?"esriLegendRight":"esriLegendLeft")},(_5a==-1)?_58:_a.byId(this.id+"_"+_55.id+"_"+_5a+"_group"));if(_6("ie")){_c.set(_a.byId(this.id+"_"+_55.id+"_"+_56.id+"_group"),"display","none");}_b.create("td",{innerHTML:_56.name.replace(/[\<]/g,"&lt;").replace(/[\>]/g,"&gt;"),align:(this.alignRight?"right":"")},_b.create("tr",{},_b.create("tbody",{},_b.create("table",{width:"95%","class":"esriLegendLayerLabel"},_5b))));}else{if(_55.visibleLayers&&(","+_55.visibleLayers+",").indexOf(","+_56.id+",")==-1){return _57;}var d=_b.create("div",{id:this.id+"_"+_55.id+"_"+_56.id,style:"display:none;","class":(_5a>-1)?(this.alignRight?"esriLegendRight":"esriLegendLeft"):""},(_5a==-1)?_58:_a.byId(this.id+"_"+_55.id+"_"+_5a+"_group"));if(_6("ie")){_c.set(_a.byId(this.id+"_"+_55.id+"_"+_56.id),"display","none");}_b.create("td",{innerHTML:(_56.name)?_56.name.replace(/[\<]/g,"&lt;").replace(/[\>]/g,"&gt;"):"",align:(this.alignRight?"right":"")},_b.create("tr",{},_b.create("tbody",{},_b.create("table",{width:"95%","class":"esriLegendLayerLabel"},d))));if(_55.legendResponse){_57=_57||this._buildLegendItems_Tools(_55,_56,d);}else{if(_55.renderer){_57=_57||this._buildLegendItems_Renderer(_55,_56,d);}}}return _57;},_buildLegendItems_Tools:function(_5c,_5d,_5e){var _5f=_5d.parentLayerId;var _60=_13.getScale(this.map);var _61=false;var _62=function(_63,_64){var i,k;for(i=0;i<_63.length;i++){if(_64.dynamicLayerInfos){for(k=0;k<_64.dynamicLayerInfos[k].length;k++){if(_64.dynamicLayerInfos[k].mapLayerId==_63[i].layerId){return _63[i];}}}else{if(_64.id==_63[i].layerId){return _63[i];}}}return {};};if(!this._respectCurrentMapScale||(this._respectCurrentMapScale&&this._isLayerInScale(_5c,_5d,_60))){var _65=_62(_5c.legendResponse.layers,_5d);var _66=_65.legend;if(!_66){}else{var _67=_b.create("tbody",{},_b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_5e));_3.forEach(_66,function(_68){if(_5c.version>=10.1&&_5c._hideDefaultSymbol&&!_68.values&&_66.length>1){}else{if((_68.url&&_68.url.indexOf("http")===0)||(_68.imageData&&_68.imageData.length>0)){_61=true;this._buildRow_Tools(_68,_67,_5c,_5d.id);}}},this);}}if(_61){_c.set(_a.byId(this.id+"_"+_5c.id+"_"+_5d.id),"display","block");if(_5f>-1){_c.set(_a.byId(this.id+"_"+_5c.id+"_"+_5f+"_group"),"display","block");this._findParentGroup(_5c.id,_5c,_5f);}}return _61;},_buildRow_Tools:function(_69,_6a,_6b,_6c){var tr=_b.create("tr",{},_6a);var _6d;var _6e;if(this.alignRight){_6d=_b.create("td",{align:"right"},tr);_6e=_b.create("td",{align:"right",width:35},tr);}else{_6e=_b.create("td",{width:35},tr);_6d=_b.create("td",{},tr);}var src=_69.url;if((!_6("ie")||_6("ie")>8)&&_69.imageData&&_69.imageData.length>0){src="data:image/png;base64,"+_69.imageData;}else{if(_69.url.indexOf("http")!==0){src=_6b.url+"/"+_6c+"/images/"+_69.url;var _6f=_6b._getToken();if(_6f){src+="?token="+_6f;}}}var img=_b.create("img",{src:src,border:0,style:"opacity:"+_6b.opacity},_6e);_b.create("td",{innerHTML:_69.label.replace(/[\<]/g,"&lt;").replace(/[\>]/g,"&gt;"),align:(this.alignRight?"right":"")},_b.create("tr",{},_b.create("tbody",{},_b.create("table",{width:"95%",dir:"ltr"},_6d))));if(_6("ie")<9){img.style.filter="alpha(opacity="+(_6b.opacity*100)+")";}},_buildLegendItems_Renderer:function(_70,_71,_72){var _73=_71.parentLayerId;var _74=_13.getScale(this.map);var _75=false;if(!this._respectCurrentMapScale||this._isLayerInScale(_70,_71,_74)){var _76;if(_70.renderer instanceof _15){if(_70.renderer.infos&&_70.renderer.infos.length>0){_75=true;_76=_b.create("tbody",{},_b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_72));_3.forEach(_70.renderer.infos,function(_77,_78){var _79=null;if(_70._editable&&_70.types){_79=this._getTemplateFromTypes(_70.types,_77.value);}var _7a=_77.label;if(!_7a||_7a.length===0){_7a=_77.value;}this._buildRow_Renderer(_70,_77.symbol,_7a,_79,_76);},this);}}if(_70.renderer instanceof _16){if(_70.renderer.infos&&_70.renderer.infos.length>0){_75=true;_76=_b.create("tbody",{},_b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_72));_3.forEach(_70.renderer.infos,function(_7b,_7c){var _7d=_7b.label;if(!_7d||_7d.length===0){_7d=_7b.minValue+" - "+_7b.maxValue;}this._buildRow_Renderer(_70,_7b.symbol,_7d,null,_76);},this);}}if(_70.renderer instanceof _14){_75=true;_76=_b.create("tbody",{},_b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_72));var _7e=null;if(_70._editable&&_70.templates&&_70.templates.length>0){_7e=_70.templates[0];}this._buildRow_Renderer(_70,_70.renderer.symbol,_70.renderer.label,_7e,_76);}if(!_70._hideDefaultSymbol&&_70.renderer.defaultSymbol){_75=true;_76=_b.create("tbody",{},_b.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},_72));this._buildRow_Renderer(_70,_70.renderer.defaultSymbol,_70.renderer.defaultLabel?_70.renderer.defaultLabel:"others",null,_76);}}if(_75){_c.set(_a.byId(this.id+"_"+_70.id+"_"+_71.id),"display","block");if(_73>-1){_c.set(_a.byId(this.id+"_"+_70.id+"_"+_73+"_group"),"display","block");this._findParentGroup(_70.id,_73);}}return _75;},_buildRow_Renderer:function(_7f,_80,_81,_82,_83){var tr=_b.create("tr",{},_83);var _84;var _85;if(this.alignRight){_84=_b.create("td",{align:"right"},tr);_85=_b.create("td",{align:"right",width:35},tr);}else{_85=_b.create("td",{width:35},tr);_84=_b.create("td",{},tr);}var _86=30;var _87=30;if(_80.type=="simplemarkersymbol"){_86=Math.min(Math.max(_86,_80.size+12),125);_87=Math.min(Math.max(_87,_80.size+12),125);}else{if(_80.type=="picturemarkersymbol"){_86=Math.min(Math.max(_86,_80.width),125);_87=Math.min(_80.height?_80.height:_87,125);}}var div=_b.create("div",{style:"width:"+_86+"px;height:"+_87+"px;"},_85);_b.create("td",{innerHTML:_81?_81.replace(/[\<]/g,"&lt;").replace(/[\>]/g,"&gt;").replace(/^#/,""):"",align:(this.alignRight?"right":"")},_b.create("tr",{},_b.create("tbody",{},_b.create("table",{width:"95%"},_84))));var _88=this._drawSymbol(div,_80,_86,_87,_82,_7f.opacity);this._surfaceItems.push(_88);},_drawSymbol:function(_89,sym,_8a,_8b,_8c,_8d){var _8e=_17.fromJson(sym.toJson()),_8f;if(_8e.type==="simplelinesymbol"||_8e.type==="cartographiclinesymbol"||_8e.type==="textsymbol"){if(!_8e.color){return;}_8f=_8e.color.toRgba();_8f[3]=_8f[3]*_8d;_8e.color.setColor(_8f);}else{if(_8e.type==="simplemarkersymbol"||_8e.type==="simplefillsymbol"){if(!_8e.color){return;}_8f=_8e.color.toRgba();_8f[3]=_8f[3]*_8d;_8e.color.setColor(_8f);if(_8e.outline&&_8e.outline.color){_8f=_8e.outline.color.toRgba();_8f[3]=_8f[3]*_8d;_8e.outline.color.setColor(_8f);}}else{if(_8e.type==="picturemarkersymbol"){_89.style.opacity=_8d;_89.style.filter="alpha(opacity=("+_8d*100+"))";}}}var _90=_e.createSurface(_89,_8a,_8b);if(_6("ie")){var _91=_90.getEventSource();_c.set(_91,"position","relative");_c.set(_91.parentNode,"position","relative");}var _92=this._getDrawingToolShape(_8e,_8c)||_17.getShapeDescriptors(_8e);var _93;try{_93=_90.createShape(_92.defaultShape).setFill(_92.fill).setStroke(_92.stroke);}catch(e){_90.clear();_90.destroy();return;}var _94=_93.getBoundingBox(),_95=_94.width,_96=_94.height,_97=-(_94.x+(_95/2)),_98=-(_94.y+(_96/2)),dim=_90.getDimensions(),_99={dx:_97+dim.width/2,dy:_98+dim.height/2};if(_95>_8a||_96>_8b){var _9a=_95>_96?_95:_96;var _9b=_8a<_8b?_8a:_8b;var _9c=(_9b-5)/_9a;_2.mixin(_99,{xx:_9c,yy:_9c});}_93.applyTransform(_99);return _90;},_getDrawingToolShape:function(_9d,_9e){var _9f,_a0=_9e?_9e.drawingTool||null:null;switch(_a0){case "esriFeatureEditToolArrow":_9f={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 E"};break;case "esriFeatureEditToolTriangle":_9f={type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 E"};break;case "esriFeatureEditToolRectangle":_9f={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 E"};break;case "esriFeatureEditToolCircle":_9f={type:"circle",cx:0,cy:0,r:10};break;case "esriFeatureEditToolEllipse":_9f={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;default:return null;}return {defaultShape:_9f,fill:_9d.getFill(),stroke:_9d.getStroke()};},_repaintItems:function(){_3.forEach(this._surfaceItems,function(_a1){this._repaint(_a1);},this);},_repaint:function(_a2){if(!_a2){return;}if(_a2.getStroke&&_a2.setStroke){_a2.setStroke(_a2.getStroke());}try{if(_a2.getFill&&_a2.setFill){_a2.setFill(_a2.getFill());}}catch(e){}if(_a2.children&&_2.isArray(_a2.children)){_3.forEach(_a2.children,this._repaint,this);}},_createDynamicLayers:function(_a3){var _a4=[],_a5;var _a6=_a3.dynamicLayerInfos||_a3.layerInfos;_3.forEach(_a6,function(_a7){var _a8={id:_a7.id};_a8.source=_a7.source&&_a7.source.toJson();var _a9;if(_a3.layerDefinitions&&_a3.layerDefinitions[_a7.id]){_a9=_a3.layerDefinitions[_a7.id];}if(_a9){_a8.definitionExpression=_a9;}var _aa;if(_a3.layerDrawingOptions&&_a3.layerDrawingOptions[_a7.id]){_aa=_a3.layerDrawingOptions[_a7.id];}if(_aa){_a8.drawingInfo=_aa.toJson();}_a8.minScale=_a7.minScale||0;_a8.maxScale=_a7.maxScale||0;_a4.push(_a8);});return _a4;},_getTemplateFromTypes:function(_ab,_ac){var i;for(i=0;i<_ab.length;i++){if(_ab[i].id==_ac&&_ab[i].templates&&_ab[i].templates.length>0){return _ab[i].templates[0];}}return null;},_findParentGroup:function(_ad,_ae,_af){var k;var _b0=_ae.dynamicLayerInfos||_ae.layerInfos;for(k=0;k<_b0.length;k++){if(_af==_b0[k].id){if(_b0[k].parentLayerId>-1){_c.set(_a.byId(this.id+"_"+_ad+"_"+_b0[k].parentLayerId+"_group"),"display","block");this._findParentGroup(_ad,_ae,_b0[k].parentLayerId);}break;}}},_addSubLayersToHide:function(_b1){var i;if(!_b1.layer.layerInfos){return;}function _b2(id,_b3){var _b4=_b1.layer.dynamicLayerInfos||_b1.layer.layerInfos,i,k;for(i=0;i<_b4.length;i++){if(_b4[i].id===id&&_b4[i].subLayerIds){for(k=0;k<_b4[i].subLayerIds.length;k++){var _b5=_b4[i].subLayerIds[k];if(_3.indexOf(_b3,_b5)===-1){_b3.push(_b5);_b2(_b5,_b3);}}}}};_3.forEach(_b1.layer._hideLayersInLegend,function(_b6){_b2(_b6,_b1.layer._hideLayersInLegend);});},_isLayerInScale:function(_b7,_b8,_b9){var i;var _ba=true;if(_b7.legendResponse&&_b7.legendResponse.layers){for(i=0;i<_b7.legendResponse.layers.length;i++){var _bb=_b7.legendResponse.layers[i];if(_b8.id==_bb.layerId){var _bc,_bd;if((!_b7.minScale&&_b7.minScale!==0)||(!_b7.maxScale&&_b7.maxScale!==0)){if(_bb.minScale==0&&_b7.tileInfo){_bc=_b7.tileInfo.lods[0].scale;}if(_bb.maxScale==0&&_b7.tileInfo){_bd=_b7.tileInfo.lods[_b7.tileInfo.lods.length-1].scale;}}else{_bc=Math.min(_b7.minScale,_bb.minScale)||_b7.minScale||_bb.minScale;_bd=Math.max(_b7.maxScale,_bb.maxScale);}if((_bc>0&&_bc<_b9)||_bd>_b9){_ba=false;}break;}}}else{if(_b7.minScale||_b7.maxScale){if((_b7.minScale&&_b7.minScale<_b9)||_b7.maxScale&&_b7.maxScale>_b9){_ba=false;}}}return _ba;},_getServiceTitle:function(_be){var _bf=_be._titleForLegend;if(!_bf){_bf=_be.url;if(!_be.url){_bf="";}else{if(_be.url.indexOf("/MapServer")>-1){_bf=_be.url.substring(0,_be.url.indexOf("/MapServer"));_bf=_bf.substring(_bf.lastIndexOf("/")+1,_bf.length);}else{if(_be.url.indexOf("/ImageServer")>-1){_bf=_be.url.substring(0,_be.url.indexOf("/ImageServer"));_bf=_bf.substring(_bf.lastIndexOf("/")+1,_bf.length);}else{if(_be.url.indexOf("/FeatureServer")>-1){_bf=_be.url.substring(0,_be.url.indexOf("/FeatureServer"));_bf=_bf.substring(_bf.lastIndexOf("/")+1,_bf.length);}}}}if(_be.name){if(_bf.length>0){_bf+=" - "+_be.name;}else{_bf=_be.name;}}}return _f.encode(_bf);},_isSupportedLayerType:function(_c0){if(_c0&&(_c0.declaredClass==="esri.layers.ArcGISDynamicMapServiceLayer"||(_c0.declaredClass==="esri.layers.ArcGISImageServiceLayer"&&_c0.version>=10.2)||_c0.declaredClass==="esri.layers.ArcGISTiledMapServiceLayer"||_c0.declaredClass==="esri.layers.FeatureLayer"||_c0.declaredClass==="esri.layers.KMLLayer"||_c0.declaredClass==="esri.layers.GeoRSSLayer"||_c0.declaredClass==="esri.layers.WMSLayer")){return true;}return false;}});_2.mixin(_19,{ALIGN_LEFT:0,ALIGN_RIGHT:1});if(_6("extend-esri")){_2.setObject("dijit.Legend",_19,_10);}return _19;});