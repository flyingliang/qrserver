/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/dijit/analysis/AnalysisBase",["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/json","dojo/has","dojo/i18n","dojo/json","dojo/Deferred","dojo/promise/all","dojo/data/ItemFileWriteStore","esri/kernel","esri/request","esri/tasks/Geoprocessor","esri/IdentityManager"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e){var _f=_2(null,{declaredClass:"esri.dijit.analysis.AnalysisBase",isOutputLayerItemUpdated:false,analysisGpServer:null,toolName:null,jobParams:null,itemParams:null,gp:null,resultParameter:null,_jobInfo:null,_popupInfo:null,_toolServiceUrl:null,_counter:null,constructor:function(){this.isOutputLayerItemUpdated=false;this._rids=[];this._counter=0;},postMixInProperties:function(){this.inherited(arguments);this.i18n={};_3.mixin(this.i18n,_7.getLocalization("esri","jsapi").common);_3.mixin(this.i18n,_7.getLocalization("esri","jsapi").analysisTools);},execute:function(_10){this.jobParams=_10.jobParams;this.itemParams=_10.itemParams;this._checkUser();},_checkUser:function(){_c.id.getCredential(this._toolServiceUrl).then(_3.hitch(this,function(_11){var _12=_11.userId;var _13=_c.id.findServerInfo(this._toolServiceUrl);var _14=_13.owningSystemUrl;if(_12){var _15=_14+"/sharing/community/users/"+_12;_d({url:_15,"content":{token:_11.token,f:"json"}}).then(_3.hitch(this,this._handleUserProfileResponse),function(_16){this.onJobFailed({message:"error getting user response",jobParams:this.jobParams});});}}),function(_17){});},_handleUserProfileResponse:function(_18){if(!_18.accountId){this.onJobFailed({message:this.i18n.orgUsrMsg,jobParams:this.jobParams});return;}if(_18.role==="account_admin"||_18.role==="account_publisher"){this._checkServiceName(_18.accountId);}else{this.onJobFailed({message:this.i18n.pubRoleMsg,jobParams:this.jobParams});return;}},_checkServiceName:function(_19){var _1a=_c.id.findServerInfo(this._toolServiceUrl);var _1b=_1a.owningSystemUrl;var _1c=_c.id.findCredential(this._toolServiceUrl);var url=_1b+"/sharing/portals/"+_19+"/isServiceNameAvailable";var _1d=_5.fromJson(this.jobParams.OutputName);var _1e={name:_1d.serviceProperties["name"],type:"Feature Service",token:_1c.token,f:"json"};_d({"url":url,"content":_1e}).then(_3.hitch(this,function(_1f){if(_1f.available){this._createService();this.onExecute(this.jobParams);}else{this.onJobFailed({message:this.i18n.servNameExists,type:"warning",jobParams:this.jobParams});}}),_3.hitch(this,function(_20){this.onJobFailed({message:"error getting service name checked",jobParams:this.jobParams});}));},_createService:function(){_c.id.getCredential(this._toolServiceUrl).then(_3.hitch(this,function(_21){var _22=_21.userId;var _23=_c.id.findServerInfo(this._toolServiceUrl);var _24=_23.owningSystemUrl;var _25=_5.fromJson(this.jobParams.OutputName);if(_22){var _26=this.itemParams.folder;var url=_24+"/sharing/content/users/"+_22+(_26&&_26!=="/"?("/"+_26):"")+"/createService";var _27={"createParameters":_5.toJson({"currentVersion":10.2,"serviceDescription":"","hasVersionedData":false,"supportsDisconnectedEditing":false,"hasStaticData":true,"maxRecordCount":2000,"supportedQueryFormats":"JSON","capabilities":"Query","description":"","copyrightText":"","allowGeometryUpdates":false,"units":"esriMeters","syncEnabled":false,"editorTrackingInfo":{"enableEditorTracking":false,"enableOwnershipAccessControl":false,"allowOthersToUpdate":true,"allowOthersToDelete":true},"xssPreventionInfo":{"xssPreventionEnabled":true,"xssPreventionRule":"InputOnly","xssInputRule":"rejectInvalid"},"tables":[],"name":_25.serviceProperties["name"]}),"outputType":"featureService",f:"json"};_d({"url":url,"content":_27},{"usePost":true}).then(_3.hitch(this,this._submitGpJob),_3.hitch(this,this._handleCreateServiceError));}}),function(_28){});},_handleCreateServiceError:function(_29){this.onJobFailed({message:_29.message,jobParams:this.jobParams});},_submitGpJob:function(_2a){this.currentGpItemId=_2a.itemId;var _2b=_5.fromJson(this.jobParams.OutputName);_2b.itemProperties={itemId:_2a.itemId};this.jobParams.OutputName=_5.toJson(_2b);this.gp.setUpdateDelay(3000);this.gp.submitJob(this.jobParams,_3.hitch(this,this._gpJobComplete),_3.hitch(this,this._gpJobStatus),_3.hitch(this,this._gpJobFailed));this.onJobSubmit(this.jobParams);},_updateItem:function(){var _2c=_c.id.findServerInfo(this._toolServiceUrl);portalUrl=_2c.owningSystemUrl;var _2d=_c.id.findCredential(this._toolServiceUrl);var _2e=_2d.userId;if(_2e){var _2f=this.itemParams.folder;var url=portalUrl+"/sharing/content/users/"+_2e+(_2f&&_2f!=="/"?("/"+_2f):"")+"/items/"+this.currentGpItemId+"/update";this.itemParams.tags=this.itemParams.tags;this.itemParams.typeKeywords="jobUrl:"+this._toolServiceUrl+"/jobs/"+this._jobInfo.jobId;var _30=_3.mixin({f:"json"},this.itemParams);var _31={};var _32;var _33={};for(_32 in this.jobParams){if(typeof this.jobParams[_32]==="string"&&(this.jobParams[_32].search(/[\{\}\[\]]/g)!==-1)){_33[_32]=_5.fromJson(this.jobParams[_32]);}else{_33[_32]=this.jobParams[_32];}}_31.analysisInfo={toolName:this.toolName,jobParams:_33};if(this._popupInfo){_31.layers=[{"id":0,"popupInfo":this._popupInfo}];}_30.text=_5.toJson(_31);_d({"url":url,"content":_30},{"usePost":true}).then(_3.hitch(this,this._handleItemUpdate),_3.hitch(this,this._handleUpdateItemError));}},_handleItemUpdate:function(_34){this.isOutputLayerItemUpdated=true;},_handleItemDataUpdate:function(_35){},_handleUpdateItemError:function(_36){this.isOutputLayerItemUpdated=true;},_handleErrorResponse:function(msg){this.onJobFailed(msg);},_refreshItem:function(){_c.id.getCredential(this._toolServiceUrl).then(_3.hitch(this,function(_37){var _38=_37.userId;var _39=_c.id.findServerInfo(this._toolServiceUrl);var _3a=_39.owningSystemUrl;if(_38){var _3b=this.itemParams.folder;var url=_3a+"/sharing/content/users/"+_38+(_3b&&_3b!=="/"?("/"+_3b):"")+"/items/"+this.currentGpItemId+"/refresh";_d({"url":url,"content":{f:"json"}},{"usePost":true}).then(_3.hitch(this,this._handleItemRefresh),_3.hitch(this,this._handleDeleteItemError));}}),function(_3c){});},_handleItemRefresh:function(_3d){},_gpJobStatus:function(_3e){_3e.jobParams=this.jobParams;this.onJobStatus(_3e);this._jobInfo=_3e;if(!this.isOutputLayerItemUpdated){this._updateItem();}var _3f="";switch(_3e.jobStatus){case "esriJobSubmitted":_3f="Submitted...";break;case "esriJobExecuting":_3f="Executing...";break;case "esriJobSucceeded":break;}},_gpJobComplete:function(_40){if(_40.jobStatus!=="esriJobFailed"){_40.jobParams=this.jobParams;this.onJobSuccess(_40);this.gp.getResultData(_40.jobId,this.resultParameter).then(_3.hitch(this,function(_41){if(!_41.value.url){_c.id.getCredential(this._toolServiceUrl).then(_3.hitch(this,function(_42){var _43=_42.userId;var _44=_c.id.findServerInfo(this._toolServiceUrl);var _45=_44.owningSystemUrl;if(_43){var _46=this.itemParams.folder;var url=_45+"/sharing/content/users/"+_43+(_46&&_46!=="/"?("/"+_46):"")+"/items/"+this.currentGpItemId+"/delete";_d({"url":url,"content":{f:"json"}},{"usePost":true}).then(_3.hitch(this,this._handleItemDelete),_3.hitch(this,this._handleDeleteItemError));}}),function(_47){});this.onJobFailed({message:this.i18n.emptyResultInfoMsg,type:"warning",jobParams:this.jobParams});}else{var _48=_41.value.url.replace("/rest/","/admin/").replace("/FeatureServer/0",".FeatureServer")+"/updateDefinition";var _49={"capabilities":"Query","hasStaticData":true,"editorTrackingInfo":{"enableEditorTracking":false,"enableOwnershipAccessControl":false,"allowOthersToUpdate":true,"allowOthersToDelete":true}};var _4a={usePost:true};var _4b={updateDefinition:_8.stringify(_49),f:"json"};_d({"url":_48,"content":_4b},_4a).then(_3.hitch(this,function(_4c){if(_4c.success===true){_41.outputLayerName=_5.fromJson(this.jobParams.OutputName).serviceProperties.name;_41.value["itemId"]=this.currentGpItemId;_41.analysisInfo={toolName:this.toolName,jobParams:this.jobParams};this.onJobResult(_41);}else{this.onJobFailed({message:"",jobParams:this.jobParams});}}),_3.hitch(this,this._handleCreateServiceError));if(_41.value.layerInfo&&_41.value.layerInfo.popupInfo){this._popupInfo=_41.value.layerInfo.popupInfo;}this._refreshItem();this._updateItem();}}));}},_gpJobFailed:function(_4d){var _4e=_3.clone(_4d);_4e.jobParams=this.jobParams;this.onJobFailed(_4d);},cancel:function(_4f){this.gp.cancelJob(_4f.jobId).then(_3.hitch(this,function(_50){if(_50.jobStatus==="esriJobCancelled"){_c.id.getCredential(this._toolServiceUrl).then(_3.hitch(this,function(_51){var _52=_51.userId;var _53=_c.id.findServerInfo(this._toolServiceUrl);var _54=_53.owningSystemUrl;if(_52){var _55=this.itemParams.folder;var url=_54+"/sharing/content/users/"+_52+(_55&&_55!=="/"?("/"+_55):"")+"/items/"+this.currentGpItemId+"/delete";_d({"url":url,"content":{f:"json"}},{"usePost":true}).then(_3.hitch(this,this._handleItemDelete),_3.hitch(this,this._handleDeleteItemError));}}),function(_56){});}}),function(_57){});},_handleItemDelete:function(_58){this.onJobCancel(_58);},_handleDeleteItemError:function(_59){this.onJobFailed(_59);},_initFolderStore:function(_5a,def){this.portal=new _5a.Portal(this._portalUrl);this.portal.signIn().then(_3.hitch(this,function(_5b){this.portalUser=_5b;this.portalUser.getFolders().then(_3.hitch(this,function(_5c){var _5d=new dojo.data.ItemFileWriteStore({data:{identifier:"id",label:"name",items:[]}});_5d.newItem({name:this.portalUser.username,id:""});_4.forEach(_5c,function(_5e){_5d.newItem({name:_5e.title,id:_5e.id});});def.resolve(_5d);}));}));},getFolderStore:function(){var def=new _9();_c.id.getCredential(this._toolServiceUrl).then(_3.hitch(this,function(_5f){var _60=_5f.userId;var _61=_c.id.findServerInfo(this._toolServiceUrl);var _62=_61.owningSystemUrl;this._portalUrl=_62;var _63=["esri/arcgis/Portal"],rid=this._counter++,_64=this;this._rids&&this._rids.push(rid);_1(_63,function(_65){var idx=_64._rids?_4.indexOf(_64._rids,rid):-1;if(idx!==-1){_64._rids.splice(idx,1);_64._initFolderStore(_65,def);}});}));return def;},_setToolServiceUrlAttr:function(_66){this._toolServiceUrl=_66;this.gp=new _e(this._toolServiceUrl);},onExecute:function(_67){},onJobSubmit:function(_68){},onJobStatus:function(_69){},onJobSuccess:function(_6a){},onJobResult:function(_6b){},onJobFailed:function(_6c){},onJobComplete:function(_6d){},onJobCancel:function(_6e){},onSave:function(){},onClose:function(){}});if(_6("extend-esri")){_3.setObject("dijit.analysis.AnalysisBase",_f,_c);}return _f;});