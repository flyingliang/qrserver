/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
require({cache:{"url:esri/dijit/editing/templates/TemplatePicker.html":"<div class=\"templatePicker\">\r\n\r\n  <table dojoType=\"dojox.grid.DataGrid\" noDataMessage=\"${emptyMessage}\" selectionMode=\"none\" autoHeight=\"${_rows}\" autoWidth=\"${_autoWidth}\"\r\n         query=\"{ query: '*' }\" dojoAttachPoint=\"grid\" class=\"grid\">\r\n  </table>\r\n  \r\n</div>"}});define("esri/dijit/editing/TemplatePicker",["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/connect","dojo/_base/html","dojo/_base/array","dojo/_base/json","dojo/_base/kernel","dojo/has","dojo/query","dojo/sniff","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dijit/_Widget","dijit/_Templated","dojo/data/ItemFileReadStore","dojox/grid/DataGrid","dojox/gfx","esri/layers/FeatureLayer","esri/symbols/PictureMarkerSymbol","esri/dijit/editing/TemplatePickerItem","esri/kernel","esri/lang","esri/request","dojo/i18n!esri/nls/jsapi","dojo/text!esri/dijit/editing/templates/TemplatePicker.html"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,gfx,_14,_15,_16,_17,_18,_19,_1a,_1b){var TP=_2([_10,_11],{declaredClass:"esri.dijit.editing.TemplatePicker",widgetsInTemplate:true,templateString:_1b,basePath:_1.toUrl("esri/dijit/editing")+"/",featureLayers:null,items:null,grouping:true,showTooltip:false,maxLabelLength:0,rows:4,_rows:0,columns:3,surfaceWidth:30,surfaceHeight:30,emptyMessage:"",useLegend:true,legendCache:{},_uniqueId:{id:0},_assumedCellWidth:90,_initialAutoWidth:300,_initialAutoHeight:200,_ieTimer:150,constructor:function(_1c,_1d){_1c=_1c||{};if(!_1c.items&&!_1c.featureLayers){console.error("TemplatePicker: please provide 'featureLayers' or 'items' parameter in the constructor");}this._dojo14x=(_8.version.minor>=4);this._itemWidgets={};if(_1c.featureLayers&&_1c.featureLayers.length){this._flChanged=1;}this._nls=_1a.widgets.templatePicker;this.emptyMessage=_1c.emptyMessage||(this._nls&&this._nls.creationDisabled)||"";},postMixInProperties:function(){this.inherited(arguments);this._preprocess();},startup:function(){this.inherited(arguments);if(this.rows==="auto"&&this.columns==="auto"){var box=_e.getContentBox(this.domNode);if(!box.w){this.domNode.style.width=this._initialAutoWidth+"px";}if(!box.h){this.domNode.style.height=this._initialAutoHeight+"px";}box=_e.getContentBox(this.domNode);this._columns=Math.floor(box.w/this._assumedCellWidth)||1;}this._applyGridPatches();this._setGridLayout();_4.connect(this.grid,"onRowClick",this,this._rowClicked);this._setGridData();this._toggleTooltip();if(_9("ie")<9){this._repaintItems=_3.hitch(this,this._repaintItems);setTimeout(this._repaintItems,this._ieTimer);}},destroy:function(){this.showTooltip=false;this._toggleTooltip();this._clearLegendInfo();this.featureLayers=this.items=this.grid=this._flItems=this._itItems=this._groupRowIndices=this._selectedCell=this._selectedInfo=this._selectedItem=null;this.inherited(arguments);},getSelected:function(){return this._selectedCell?this._selectedItem:null;},clearSelection:function(){var _1e=this._selectedCell,_1f=this._selectedInfo;if(_1e){this._rowClicked({cellNode:_1e,rowIndex:_1f.selRow,cellIndex:_1f.selCol});}},update:function(_20){var _21=(this.rows==="auto"&&this.columns==="auto"&&_20)?true:false,_22=this.grid,box;if(_21){var _23=this.domNode,id=_23.id,_24,_25=_8.query("#"+id+".templatePicker div.item")[0];box=_e.getContentBox(_23);_25=_25&&_25.parentNode;if(_25){_24=_5.coords(_25).w;}else{_24=this._assumedCellWidth;}this._columns=Math.floor((box.w-_22.views.views[0].getScrollbarWidth())/_24);this._columns=this._columns||1;}var _26=this._rows;this._preprocess();var _27=this._rows;this._setGridLayout();this._setGridData();if(_27!==_26){_22.set("autoHeight",this._rows,false);}if(_21){_22._resize({w:box.w,h:box.h});_22.viewsHeaderNode.style.display="none";}else{_22.update();}this._toggleTooltip();var _28=this,_29=this.getSelected();if(_29){_22.store.fetch({onComplete:function(its){var _2a=_28._locate(_29,_28._selectedInfo,its);var _2b=_2a&&_22.views.views[0].getCellNode(_2a[0],_2a[1]);if(_2b){_28._rowClicked({cellNode:_2b,rowIndex:_2a[0],cellIndex:_2a[1]},true);}}});}if(_9("ie")<9){setTimeout(this._repaintItems,this._ieTimer);}var _2c=this.featureLayers,_2d=this.items;if((!_2c||!_2c.length)&&(!_2d||!_2d.length)&&_22&&this.emptyMessage){_22.showMessage(this.emptyMessage);}},onSelectionChange:function(){},_setUseLegendAttr:function(use){var _2e=this.useLegend;if(!this._started||_2e!==use){if(use){this._flChanged=1;}else{this._clearLegendInfo();}}this.useLegend=use;},_setFeatureLayersAttr:function(_2f){var _30=this.featureLayers;if(!this._started||_30!==_2f){this._flChanged=1;}this.featureLayers=_2f;},_adjustRowsCols:function(_31){if(this.rows==="auto"&&this.columns==="auto"){if(!this._started){this._rows=false;this._columns=null;this._autoWidth=false;}return;}var len=0;this._rows=this.rows;this._columns=this.columns;if(this.rows==="auto"){if(this.featureLayers){if(this.grouping){len=_31.length;_6.forEach(_31,function(_32){len+=Math.ceil(_32.length/this.columns);},this);}else{_6.forEach(_31,function(_33){len+=_33.length;},this);len=Math.ceil(len/this.columns);}}else{len=Math.ceil(_31.length/this.columns);}this._rows=len;}else{if(this.columns==="auto"){if(this.featureLayers){if(this.grouping){len=3;}else{_6.forEach(_31,function(_34){len+=_34.length;},this);len=Math.ceil(len/this.rows);}}else{len=Math.ceil(_31.length/this.rows);}this._columns=len;}}},_preprocess:function(){if(this.items){this.grouping=false;}this._autoWidth=false;if(this.rows==="auto"||this.columns==="auto"){this._autoWidth=true;}var _35;if(this.featureLayers){if(this.useLegend&&this._flChanged){this._legendIndices=[];this._loadingIndices=[];this._legendSymbols={};this._ignoreLegends();this._loadingLegends=[];clearTimeout(this._legendTimer);this._legendTimer=null;this._processSelectionLayers();this._flChanged=0;}if(_6.every(this.featureLayers,function(_36){return _36.loaded;})){_35=this._flItems=this._getItemsFromLayers(this.featureLayers);this._adjustRowsCols(_35);}else{var _37=this.featureLayers.length;var _38=[];_6.forEach(this.featureLayers,function(_39){if(_39.loaded){_37--;_38.push(_39);}else{var _3a=_4.connect(_39,"onLoad",this,function(_3b){_4.disconnect(_3a);_3a=null;_37--;_38.push(_3b);if(!_37){_35=this._flItems=this._getItemsFromLayers(_38);this._adjustRowsCols(_35);this.update();}});}},this);}}else{_35=this._itItems=this._getItemsFromItems(this.items);this._adjustRowsCols(_35);}},_processSelectionLayers:function(){var map,_3c,_3d,_3e,key,_3f,_40,_41={};_6.forEach(this.featureLayers,function(_42,idx){if(_42.mode===_14.MODE_SELECTION&&_42._map&&_42.url&&_42._params.drawMode&&!_42.source){_3c=_3.trim(_42._url.path).replace(/\/(MapServer|FeatureServer).*/ig,"/MapServer").replace(/^https?:\/\//ig,"").toLowerCase();_3d=(_41[_3c]=_41[_3c]||{});_3e=(_3d.featureLayers=_3d.featureLayers||{});_3f=(_3d.indices=_3d.indices||[]);_3e[idx]=_42;_3f.push(idx);map=_42._map;}});if(map){_6.forEach(map.layerIds,function(_43){_43=map.getLayer(_43);if(_43&&_43.url&&(_43.getImageUrl||_43.getTileUrl)&&_43.loaded&&_43.version>=10.1){_3c=_3.trim(_43._url.path).replace(/(\/MapServer).*/ig,"$1");key=_3c.replace(/^https?:\/\//ig,"").toLowerCase();if(_41[key]&&(!_41[key].mapServiceUrl)){_3d=_41[key];_3d.mapServiceUrl=_3c;_3d.mapServiceLayer=_43;this._legendIndices=this._legendIndices.concat(_3d.indices);_40=this._fetchLegend({pickerInstance:this,info:_3d},key);if(_40.then){this._loadingIndices=this._loadingIndices.concat(_3d.indices);this._loadingLegends.push(_40);}else{this._processLegendResponse(_40,_3d);}}}},this);}},_fetchLegend:function(_44,key){var _45=TP.prototype,_46=_45.legendCache[key];if(!_46){_46=(_45.legendCache[key]=_19({url:_44.info.mapServiceUrl+"/legend",content:{f:"json"},callbackParamName:"callback"}));_46._contexts=[_44];_46.addBoth(function(_47){if(_46.canceled){return;}_45.legendCache[key]=_47;var _48=_46._contexts;_46._contexts=null;_6.forEach(_48,function(_49){var _4a=_49.pickerInstance,_4b=_49.info,_4c;if(_4a._destroyed){return;}_6.forEach(_4b.indices,function(idx){_4c=_6.indexOf(_4a._loadingIndices,idx);if(_4c>-1){_4a._loadingIndices.splice(_4c,1);}});_4c=_6.indexOf(_4a._loadingLegends,_46);if(_4c>-1){_4a._loadingLegends.splice(_4c,1);}_4a._processLegendResponse(_47,_4b);});});}else{if(_46.then){_46._contexts.push(_44);}}return _46;},_clearLegendInfo:function(){clearTimeout(this._legendTimer);this._ignoreLegends();this._legendIndices=this._loadingIndices=this._legendSymbols=this._loadingLegends=this._legendTimer=null;},_ignoreLegends:function(){if(this._loadingLegends){_6.forEach(this._loadingLegends,function(_4d){var _4e=-1;_6.some(_4d._contexts,function(_4f,idx){if(_4f.pickerInstance===this){_4e=idx;}return (_4e>-1);},this);if(_4e>-1){_4d._contexts.splice(_4e,1);}},this);}},_processLegendResponse:function(_50,_51){if(_50&&!(_50 instanceof Error)){_6.forEach(_51.indices,function(idx){var _52=_51.featureLayers[idx].layerId,i,_53=_51.mapServiceUrl+"/"+_52+"/images/",_54=_51.mapServiceLayer._getToken(),_55,obj,_56,url;if(this._legendSymbols[idx]){return;}_55=null;_6.some(_50.layers,function(_57){if(_57.layerId==_52){_55=_57;}return !!_55;});if(_55){obj=(this._legendSymbols[idx]={});_6.forEach(_55.legend,function(_58){_56=_58.values;if(_56&&_56.length){for(i=0;i<_56.length;i++){obj[_56[i]]=_58;}}else{obj.defaultSymbol=_58;}url=_58.url;if(url&&!_58._fixed){_58._fixed=1;if((url.search(/https?\:/)===-1)){_58.url=_53+url;}if(_54&&_58.url.search(/https?\:/)!==-1){_58.url+=(((_58.url.indexOf("?")>-1)?"&":"?")+"token="+_54);}}});}},this);}else{var _59;_6.forEach(_51.indices,function(idx){_59=_6.indexOf(this._legendIndices,idx);if(_59>-1){this._legendIndices.splice(_59,1);}},this);}var _5a=this;if(_5a._started&&!_5a._legendTimer){_5a._legendTimer=setTimeout(function(){clearTimeout(_5a._legendTimer);_5a._legendTimer=null;if(!_5a._destroyed){_5a.update();}},0);}},_applyGridPatches:function(){var _5b=this.grid;var _5c=_5b.adaptWidth,_5d,i,_5e;_5b.adaptWidth=function(){_5d=this.views.views;for(i=0;_5e=_5d[i];i++){_f.set(_5e.headerNode,"display","block");}_5c.apply(this,arguments);for(i=0;_5e=_5d[i];i++){_f.set(_5e.headerNode,"display","none");}};if(this._dojo14x){if(this.rows!=="auto"&&this.columns!=="auto"){var _5f=_4.connect(_5b,"_onFetchComplete",this,function(){_4.disconnect(_5f);this.grid.set("autoHeight",this._rows);});}_4.connect(_5b,"_onDelete",this,this._destroyItems);_4.connect(_5b,"_clearData",this,this._destroyItems);_4.connect(_5b,"destroy",this,this._destroyItems);var _60=_5b.focus;if(_60&&_60.findAndFocusGridCell){_60.findAndFocusGridCell=function(){return false;};}}},_setGridLayout:function(){var _61=function(_62){return function(_63,_64){return this._cellGet(_62,_63,_64);};};var _65=_3.hitch(this,this._cellFormatter),_66=[],_67=this._columns,i;for(i=0;i<_67;i++){_66.push({field:"cell"+i,get:_3.hitch(this,_61(i)),formatter:_65});}var _68={cells:[_66]};if(this.grouping){var _69={field:"groupName",colSpan:_67,get:_3.hitch(this,this._cellGetGroup),formatter:_3.hitch(this,this._cellGroupFormatter)};_68.cells.push([_69]);}var _6a=this.grid,_6b=_13.prototype.rowsPerPage;_6a.set("rowsPerPage",(this._rows>_6b)?this._rows:_6b);_6a.set("structure",_68);},_setGridData:function(){var _6c=[];if(this.grouping){this._groupRowIndices=[];var _6d,_6e,_6f=this._columns;_6.forEach(this._flItems,function(_70,idx){_6c.push({});var _71=(idx===0)?0:(_6d+_6e+1);this._groupRowIndices.push(_71);_6d=_71;_6e=Math.ceil(_70.length/_6f);_6c=_6c.concat(this._getStoreItems(_70));},this);}else{if(this.featureLayers){_6.forEach(this._flItems,function(_72){_6c=_6c.concat(_72);});_6c=this._getStoreItems(_6c);}else{_6c=this._getStoreItems(this._itItems);}}var _73=new _12({data:{items:_6c}});this.grid.setStore(_73);},_toggleTooltip:function(){if(this.showTooltip){if(this.tooltip){return;}this.tooltip=_d.create("div",{"class":"tooltip"},this.domNode);this.tooltip.style.display="none";this.tooltip.style.position="fixed";var _74=this.grid;this._mouseOverConnect=_4.connect(_74,"onCellMouseOver",this,this._cellMouseOver);this._mouseOutConnect=_4.connect(_74,"onCellMouseOut",this,this._cellMouseOut);}else{if(this.tooltip){_4.disconnect(this._mouseOverConnect);_4.disconnect(this._mouseOutConnect);_d.destroy(this.tooltip);this.tooltip=null;}}},_rowClicked:function(evt,_75){var _76=evt.cellNode,row=evt.rowIndex,col=evt.cellIndex;var _77=this._getCellInfo(_76,row,col);if(!_77){return;}var _78=this.grid.store;if(_78.getValue(_77,"loadingCell")){return;}if(this._selectedCell){_c.remove(this._selectedCell,"selectedItem");}if(_76!==this._selectedCell){_c.add(_76,"selectedItem");this._selectedCell=_76;this._selectedItem={featureLayer:_78.getValue(_77,"layer"),type:_78.getValue(_77,"type"),template:_78.getValue(_77,"template"),symbolInfo:_78.getValue(_77,"symbolInfo"),item:this._getItem(_77)};this._selectedInfo={selRow:row,selCol:col,index1:_78.getValue(_77,"index1"),index2:_78.getValue(_77,"index2"),index:_78.getValue(_77,"index")};}else{this._selectedCell=this._selectedInfo=this._selectedItem=null;}if(!_75){this.onSelectionChange();}},_locate:function(_79,_7a,_7b){var _7c=this.grid.store,_7d=new Array(this._columns);var _7e,_7f=_7a.index1,_80=_7a.index2,_81=_7a.index,_82=_79.item;_6.some(_7b,function(_83,_84){return _6.some(_7d,function(_85,_86){var _87=_7c.getValue(_83,"cell"+_86);if(_87&&(_82?(_81===_7c.getValue(_87,"index")):(_7f===_7c.getValue(_87,"index1")&&_80===_7c.getValue(_87,"index2")))){_7e=[_84,_86];return true;}else{return false;}});});return _7e;},_getCellInfo:function(_88,row,col){if(!_88){return;}var _89=this.grid;var _8a=_89.getItem(row);var _8b=_89.store.getValue(_8a,"cell"+col);return _8b;},_getItem:function(_8c){var _8d=this.items;if(_8d){return _8d[this.grid.store.getValue(_8c,"index")];}},_cellMouseOver:function(evt){var _8e=this.tooltip;var _8f=evt.cellNode,row=evt.rowIndex,col=evt.cellIndex;var _90=this._getCellInfo(_8f,row,col);if(_8e&&_90){var _91=this.grid.store;var _92=_91.getValue(_90,"template");var _93=_91.getValue(_90,"type");var _94=_91.getValue(_90,"symbolInfo");var _95=_91.getValue(_90,"layer");var _96=this._getItem(_90);var _97=(_96&&(_96.label+(_96.description?(": "+_96.description):"")))||(_92&&(_92.name+(_92.description?(": "+_92.description):"")))||(_93&&_93.name)||(_94&&(_94.label+(_94.description?(": "+_94.description):"")))||((_95&&_95.name+": ")+"Default");_8e.style.display="none";_8e.innerHTML=_97;var _98=_5.coords(_8f.firstChild);_f.set(_8e,{left:(_98.x)+"px",top:(_98.y+_98.h+5)+"px"});_8e.style.display="";}},_cellMouseOut:function(){var _99=this.tooltip;if(_99){_99.style.display="none";}},_destroyItems:function(){var _9a=this._itemWidgets,w;for(w in _9a){if(!_9a[w]){continue;}_9a[w].destroy();delete _9a[w];}},_repaintItems:function(){var _9b=this._itemWidgets,w;for(w in _9b){var _9c=_9b[w];if(_9c){_9c._repaint(_9c._surface);}}},_getStoreItems:function(_9d){var uid=this._uniqueId;_9d=_6.map(_9d,function(_9e){return _3.mixin({"surfaceId":"tpick-surface-"+(uid.id++)},_9e);});var len=_9d.length,_9f=0,obj={},k=0,_a0,_a1=[],_a2=true,_a3=this._columns;while(_9f<len){_a2=true;_a0="cell"+k;obj[_a0]=_9d[_9f];_9f++;k++;if(k%_a3===0){_a2=false;_a1.push(obj);obj={};k=0;}}if(_a2&&len){_a1.push(obj);}return _a1;},_getItemsFromLayers:function(_a4){var _a5=[];_6.forEach(_a4,function(_a6,_a7){_a5.push(this._getItemsFromLayer(_a6,_a7));},this);return _a5;},_getItemsFromLayer:function(_a8,_a9){var _aa=[];if(this.useLegend&&_6.indexOf(this._loadingIndices,_a9)>-1){return [{label:(this._nls&&this._nls.loading)||"",symbol:null,layer:_a8,type:null,template:null,index1:_a9,index2:0,loadingCell:1}];}var _ab=[];_ab=_ab.concat(_a8.templates);_6.forEach(_a8.types,function(_ac){var _ad=_ac.templates;_6.forEach(_ad,function(_ae){_ae._type_=_ac;});_ab=_ab.concat(_ad);});_ab=_6.filter(_ab,_18.isDefined);var _af=_a8.renderer;if(_af){var _b0=_af.declaredClass.replace("esri.renderer.","");if(_ab.length>0){_6.forEach(_ab,function(_b1){var _b2=_b1.prototype;if(_b2){var _b3=_af.getSymbol(_b2);if(_b3){var _b4=null,pms,_b5;if(this.useLegend&&_6.indexOf(this._legendIndices,_a9)>-1){_b5=this._legendSymbols&&this._legendSymbols[_a9];if(_b5){switch(_b0){case "SimpleRenderer":_b4=_b5.defaultSymbol;break;case "UniqueValueRenderer":_6.some(_af.infos,function(_b6){if(_b6.symbol===_b3){_b4=_b5[_b6.value];}return !!_b4;});break;case "ClassBreaksRenderer":_6.some(_af.infos,function(_b7){if(_b7.symbol===_b3){_b4=_b5[_b7.maxValue];}return !!_b4;});break;}}if(_b4){pms=_7.fromJson(_7.toJson(_15.defaultProps));pms.url=_b4.url;pms.imageData=_b4.imageData;pms.contentType=_b4.contentType;pms.width=_b4.width;pms.height=_b4.height;if(!_18.isDefined(pms.width)||!_18.isDefined(pms.height)){pms.width=15;pms.height=15;}_b4=new _15(pms);}}_aa.push({label:this._trimLabel(_b1.name),symbol:_b4||_b3,legendOverride:!!_b4,layer:_a8,type:_b1._type_,template:_b1,index1:_a9,index2:_aa.length});}}delete _b1._type_;},this);}else{var _b8=[];if(_b0==="TemporalRenderer"){_af=_af.observationRenderer;if(_af){_b0=_af.declaredClass.replace("esri.renderer.","");}}switch(_b0){case "SimpleRenderer":_b8=[{symbol:_af.symbol,label:_af.label,description:_af.description}];break;case "UniqueValueRenderer":case "ClassBreaksRenderer":_b8=_af.infos;break;}_aa=_6.map(_b8,function(_b9,idx){return {label:this._trimLabel(_b9.label),description:_b9.description,symbolInfo:_3.mixin({constructor:function(){}},_b9),symbol:_b9.symbol,layer:_a8,index1:_a9,index2:idx};},this);}}return _aa;},_getItemsFromItems:function(_ba){return _6.map(_ba,function(_bb,idx){_bb=_3.mixin({index:idx},_bb);_bb.label=this._trimLabel(_bb.label);return _bb;},this);},_trimLabel:function(_bc){var max=this.maxLabelLength;if(max&&_bc){if(_bc.length>max){_bc=_bc.substr(0,max)+"...";}}return _bc||"";},_cellGet:function(_bd,_be,_bf){if(!_bf){return "";}return this.grid.store.getValue(_bf,"cell"+_bd);},_cellFormatter:function(_c0){if(_c0){var _c1=this._itemWidgets,_c2=this.grid.store;var sid=_c2.getValue(_c0,"surfaceId");var w=_c1[sid];if(!w){w=(_c1[sid]=new _16({id:sid,label:_c2.getValue(_c0,"label"),symbol:_c2.getValue(_c0,"symbol"),legendOverride:_c2.getValue(_c0,"legendOverride"),surfaceWidth:this.surfaceWidth,surfaceHeight:this.surfaceHeight,template:_c2.getValue(_c0,"template")}));}return w||"";}else{return "";}},_cellGetGroup:function(_c3,_c4){if(!this._groupRowIndices){return "";}var _c5=_6.indexOf(this._groupRowIndices,_c3);if(!_c4||_c5===-1){return "";}return (this.featureLayers[_c5]&&this.featureLayers[_c5].name)||"";},_cellGroupFormatter:function(_c6){if(_c6){return "<div class='groupLabel'>"+_c6+"</div>";}else{return "";}}});if(_9("extend-esri")){_3.setObject("dijit.editing.TemplatePicker",TP,_17);}return TP;});